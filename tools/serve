#!/bin/bash

# Prevent a shell fork from living longer than its initiator? https://unix.stackexchange.com/a/364317/136107
my_exit() {
    [ "$racing" ] && pid=$!
    [ "$pid" ] && kill "$pid"
    echo "Killed git pull daemon (was $pid)"
}
trap my_exit EXIT

racing=Y
tools/git-autopull &
pid=$!
racing=

ls --color=never ./*.py "tools/serve" | entr -r ./server.py 8080 && echo "file changed, stopping and restarting..."
